---
title: "Desirability of Outcome Ranking"
author: Michelle Earley, Weixiao Dai, Qing Pan, Toshi Hamasaki, Scott Evans, Diane
  Uschner
date: "February 5, 2020"
documentclass: jss
classoption: article
output: 
  pdf_document:
    includes:
      in_header: header.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(DOOR)
```

# Introduction

# Methods
Consider the situation of a study with treatment groups $A$ and $B$, and DOOR outcome $Y$ with $K$ levels. 
Let the total sample size be denoted by $n$, where $n = n_A + n_B$ and $n_t$ denotes
the sample size in group $t \in \{A, B\}$. Let $n_{t,k}$ denote number of subjects in group $t$ that experienced outcome $Y = k$.
The situation is presented in Table \ref{tab:door-summary}.

\begin{table}[ht]
\centering
\begin{tabular}{ccc}
\toprule
Outcome & \multicolumn{2}{c}{Treamtent Group} \\
$Y = k$ & $A$ & $B$\\
\midrule
1 & $n_{A,1}$ & $n_{B,1}$\\
2 & $n_{A,2}$ & $n_{B,2}$\\
\vdots & \vdots & \vdots \\
$K$ & $n_{A,K}$ & $n_{B,K}$\\
\midrule
Total & $n_A$ & $n_B$\\
\bottomrule
\end{tabular}
\caption{DOOR summary table of sample sizes by DOOR outcome and treatment group.}
\label{tab:door-summary}
\end{table}

Denote the vector of sample sizes in group $t \in \{A, B\}$ by outcome as $v_t = (n_{t,1}, \dots, n_{t,K})^T$.

## Point estimates 

### The DOOR probability

The DOOR probability is defined as the probability $p = P(Y_A \geq Y_B)$ that a randomly selected participant
in group $A$ experiences a better outcome than a randomly selected participant in group $B$. The DOOR probability
$p$ can be estimated by the fractions of tuples $(Y_{A,i}, Y_{B,j})$, where $Y_{A,i} \geq Y_{B,j}$, namely

\begin{equation}
\hat{p} = \sum_{i = 1}^{n_A}\sum_{j = 1}^{n_B} \frac{1(Y_{A,i} \geq Y_{B,j})}{n_A\cdot n_B}.
\end{equation}

We can use the DOOR summary in table \ref{tab:door-summary} to calculate this estimate more efficiently. We recognize 
that for each participant in group $B$ that had outcome $Y = k$, there are $n_{A,k}$ participants in group $A$ that had 
the same outcome, and $\sum_{j = k+1}^K n_{A, j}$ participants that had a larger outcome. Denote by $M$ the symmetric matrix
that contains the shifted sample size vector $v_A$ of group $A$ in rows and columns:

\begin{equation}
M = 
\begin{pmatrix}
n_{A,2} & n_{A,3} & \dots & n_{A,K} & 0\\
n_{A,3} & n_{A,4} & \dots & 0 & 0\\
\vdots & \vdots  & \dots & \vdots  & \vdots \\
n_{A,K} & 0  & \dots & 0 & 0\\
0  & 0 & \dots & 0 & 0\\
\end{pmatrix}
\end{equation}.

We can then estimate the DOOR probability by taking the matrix product of $M$ and $v_B$ for the probability of observing a larger outcome in group $A$ than in $B$, and adding half the scalar product of $v_A$ and $v_B$ for the probability of observing the same outcome in both groups, and dividing by the total number of possible comparisons $n_A\cdot n_B$ 

\begin{equation}
\hat{p} = \frac{1}{n_A \cdot n_B}\cdot(1^{T} M v_B + \frac{1}{2} v_A^{T} v_B.)
\end{equation}

### Difference in means

### Partial Score


## Conference Intervals
  
### Bootstrap CI for the DOOR probability

The $(1-\alpha)$ bootstrap confidence interval is given by 
\begin{equation}
(1-\alpha)-CI = [\hat{p}_{\alpha/2}, \hat{p}_{1- \alpha/2}],
\end{equation}
where $\hat{p}_{\gamma}$ denotes the $\gamma$ quantile of the bootstrap distribution of $\hat{p}$. 
The bootstrap distribution is generated by resampling $y$ with replacement a number of $B$ times, 
and calculating $\hat{p}$ for the resampled $y'$, so that $\hat{p}_{\gamma} = \hat{p}_{(\gamma\cdot B)}$, 
where $\hat{p}_{(\gamma\cdot B)}$ denotes the order statistic of $\hat{p}$.

```{r, echo = F, fig.cap="Bootstrap distribution of $\\hat{p}$", message = F}
library(DOOR)
set.seed(123)
N <- 26
tx <- c("A", "B")
seq <- rep(tx, each = N/2)
DOOR <- sample(1:4, size = N, replace = TRUE)
data <- data.frame(seq, DOOR)
res <- get_door_summary(data, "seq", "DOOR")
B <- 1000
p <- replicate(B,
      {
        x <- res$DOOR
        #N <- apply(res[-1], 2, sum)
        N <- sum(apply(res[-1], 2, sum))
        p <- apply(res[2] + res[3], 2, function(n) n/ N)
        data <- data.frame(
          seq = rep(tx, times = N),
          DOOR = sample(x, size = N, replace = TRUE, prob = p)
          #DOOR = as.vector(sapply(tx, function(tx) sample(x, size = N[tx], replace = TRUE, prob = p[,tx])))
          )
        res <- get_door_summary(data, "seq", "DOOR")
        get_door_probability(res)
      })
hist(p)

```




Another way is to resample from the distribution of $y$ conditional on the treatment group, $(y|T = t)$,.
This allows for different variances in both groups.


### Wilcoxon rank sum method

### Asymptotic Formula for the DOOR CI

## Implementation

We created an \proglang{R} package for the DOOR probability. The following code generates Table \ref{tab:door-summary} for an example of $n = 300$ participants and a DOOR outcome with $K = 4$ levels.

```{r message = FALSE}
set.seed(123)
n <- 300
seq <- rep(c("A", "B"), each = n/2)
DOOR <- sample(1:4, size = n, replace = TRUE)
data <- data.frame(seq, DOOR)
(res <- get_door_summary(data, "seq", "DOOR"))
```

The following command creates Figure \ref{fig:door-comparison} that visualizes Table \ref{tab:door-summary}.

```{r, fig.cap="\\label{fig:door-comparison}Visualization of the DOOR summary"}
plot_door_comparison(res)
```


\newpage

\appendix

# Variance and Power calculation for DOOR Probability outcome


Assume that the ordinal DOOR outcomes in the control group follows the multinomial distribution with $pr_c=(pr_{c,1},\dots, pr_{c,p}$) where $pr_c$ is the vector of probabilities falling into $p$ DOOR outcome categories and $pr_{c,i}$ is the probability falling into the ith category. Similarly, in the treatment group, the DOOR outcomes follows a multinomial distribution with $pr_t=(pr_{t,1},\dots, pr_{t,p})$. 

The sample size in the control group is $m_c\cdot k_c$ where $m_c$ is the average number of patients in a hospital and $k_c$ is the number of hospitals in the control group. The corresponding numbers are $m_c\cdot k_c$ in the treatment group. Assuming an intra-cluster correlation $ICC$, the design effect are $DE_c = 1+(m_c-1)\cdot ICC$ and $DE_t = 1+(m_t-1)\cdot ICC$, respectively. Therefore, our study is equivalent to a randomized trial with independent participants of size $n_c=m_c\cdot k_c/DE_c$ and $n_t=m_t\cdot k_t/DE_t$ in the control and treatment groups, respectively. 

The variance-covariance matrix of $\hat{pr}_c=(\hat{pr}_{c,1},\dots, \hat{pr}_{c,p})$ is a $p\times p$ matrix $COV_c$ where 
\begin{align}
COV_c[i,j] &= - \frac{pr_{c,i} \cdot pr_{c,j}}{n_c} \text{ if } i \neq j \\ 
COV_c[i,i] &=  \frac{pr_{c,i} \cdot (1-pr_{c,i})}{n_c} \text{ for } i = 1, \dots, p.
\end{align}
The variance-covariance matrix of $\hat{pr}_t=(\hat{pr}_{t,1},\dots, \hat{pr}_{t,p})$ is a $p\times p$ matrix $COV_t$ where 
\begin{align}
COV_t[i,j] &= - \frac{pr_{t,i} \cdot pr_{t,j}}{n_t} \text{ if } i \neq j\\ 
COV_t[i,i] &=  \frac{pr_{t,i} \cdot (1-pr_{t,i})}{n_t} \text{ for } i = 1, \dots, p.
\end{align}
The variance-covariance matrix of the combined vector $\hat{pr} =(\hat{pr}_{c,1}, \dots, \hat{pr}_{c,p}, \hat{pr}_{t,1}, \dots, \hat{pr}_{t,p})$ is a $2p\times 2p$ matrix $COV$ which has $COV_c$ and $COV_t$ on the diagonal. The two off-diagonal $p\times p$ quadrants are all zero because participants in the control group and those in the treatment group are independent.

The expectation of the DOOR probability is
\begin{equation}
DOOR_{pr} = \sum_{i=1}^p \sum_{j=1}^p (pr_{c,i}\cdot pr_{t,j}\cdot I(i>j))+0.5 \cdot \sum_{i=1}^p pr_{c,i} \cdot pr_{t,i}.
\end{equation}
Taking the derivative of $DOOR_{pr}$ over the vector $pr=(pr_{c,1}, \dots, pr_{c,p}, pr_{t,1},\dots, pr_{t,p})$, we get a $2p\times 1$ vector $\delta$ which is the concatenation of $\delta_c (p\times 1)$ and $\delta_t (p\times 1)$. For $i=1,\dots,p$ and $j=1,\dots,p$,
\begin{align}
\delta_c[i] & = \sum_{j=1}^p (pr_{t,j}\cdot I(i>j))+0.5\cdot pr_{t,i}\\
\delta_t[j] & = \sum_{i=1}^p (pr_{c,i}\cdot I(i>j))+0.5\cdot pr_{c,j}.
\end{align}
Applying Delta method, the variance of 
\begin{equation}
\hat{DOOR}_{pr}=
\sum_{i=1}^p \sum_{j=1}^p (\hat{pr}_{c,i}\cdot \hat{pr}_{t,j}\cdot I(i>j)) + 
  0.5\cdot \sum_{i=1}^p \hat{pr}_{c,i}\cdot \hat{pr}_{t,i}
\end{equation}
goes as follows - $var = \delta^{t}\cdot COV\cdot \delta$
And the test statistic is 
$test=(\hat{DOOR}_{pr}-0.5)/\sqrt(var)$, 
which is going to be compared to a standard normal distribution. 
The power for a one-sided test is 
$power = Pr( z > 0.5/\sqrt(var)+1.68-DOOR_{pr}/\sqrt(var))$.




